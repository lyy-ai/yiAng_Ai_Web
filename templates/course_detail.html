{% extends "layout.html" %}

{% block title %}{{ course.title }} - {{ config.site_name }}{% endblock %}

{% block content %}
<!-- 如果是外部链接课程，自动跳转 -->
{% if course.external_url %}
<script>
    window.location.href = "{{ course.external_url }}";
</script>
<section class="py-5">
    <div class="container text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3">正在跳转到课程详情页...</p>
        <p class="text-muted">如果未自动跳转，请点击：<a href="{{ course.external_url }}" target="_blank">{{ course.title }}</a></p>
    </div>
</section>
{% else %}
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <span class="badge bg-info me-2">{{ course.category }}</span>
                            <span class="badge bg-secondary">{{ course.level }}</span>
                        </div>

                        <h1 class="fw-bold mb-3">{{ course.title }}</h1>

                        <div class="d-flex gap-4 mb-4 text-muted">
                            <span><i class="fas fa-user text-primary"></i> {{ course.instructor }}</span>
                            <span><i class="fas fa-clock text-primary"></i> {{ course.duration }}</span>
                        </div>

                        {% if course.video_url %}
                        <div class="mb-4">
                            <div class="ratio ratio-16x9 rounded overflow-hidden shadow">
                                <iframe src="https://player.bilibili.com/player.html?bvid={{ course.video_url|extract_bv }}&page=1&high_quality=1&danmaku=0"
                                        scrolling="no"
                                        border="0"
                                        frameborder="no"
                                        framespacing="0"
                                        allowfullscreen="true">
                                </iframe>
                            </div>
                            <div class="mt-2 text-end">
                                <a href="{{ course.video_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fab fa-bilibili"></i> 在B站观看完整版
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <div class="bg-light p-5 text-center rounded mb-4">
                            <i class="fas fa-play-circle fa-5x text-primary"></i>
                            <p class="mt-3 text-muted">课程预览视频</p>
                        </div>
                        {% endif %}

                        <h4 class="fw-bold mb-3"><i class="fas fa-info-circle"></i> 课程介绍</h4>
                        <p class="lead">{{ course.description }}</p>

                        <h4 class="fw-bold mb-3 mt-4"><i class="fas fa-list-ul"></i> 课程目录</h4>
                        {% if course.syllabus_image %}
                        <div class="text-center">
                            <img src="{{ course.syllabus_image }}" class="img-fluid rounded shadow" alt="课程目录">
                        </div>
                        {% else %}
                        <ul class="list-group">
                            <li class="list-group-item"><i class="fas fa-check-circle text-success"></i> 第1章：基础入门</li>
                            <li class="list-group-item"><i class="fas fa-check-circle text-success"></i> 第2章：核心概念</li>
                            <li class="list-group-item"><i class="fas fa-check-circle text-success"></i> 第3章：实战项目</li>
                            <li class="list-group-item"><i class="fas fa-check-circle text-success"></i> 第4章：进阶技巧</li>
                        </ul>
                        {% endif %}

                        <h4 class="fw-bold mb-3 mt-4"><i class="fas fa-tags"></i> 相关标签</h4>
                        <div>
                            {% for tag in course.tags %}
                            <span class="badge bg-primary me-2 mb-2">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow sticky-top" style="top: 20px;">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <h2 class="text-primary fw-bold">{{ course.price }}</h2>
                            <p class="text-muted">课程价格</p>
                        </div>

                        <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#purchaseModal">
                            <i class="fas fa-shopping-cart"></i> 立即购买
                        </button>
                        <button class="btn btn-outline-primary w-100 mb-3" id="favoriteBtn" onclick="toggleFavorite(this)">
                            <i class="fas fa-heart"></i> <span id="favText">收藏课程</span>
                        </button>

                        <hr>

                        <h6 class="fw-bold mb-3">课程特色</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-check text-success"></i> 系统化课程设计</li>
                            <li class="mb-2"><i class="fas fa-check text-success"></i> 实战项目驱动</li>
                            <li class="mb-2"><i class="fas fa-check text-success"></i> 讲师答疑支持</li>
                            <li class="mb-2"><i class="fas fa-check text-success"></i> 终身学习权限</li>
                        </ul>
                    </div>
                </div>

                {% if related_courses %}
                <div class="card shadow mt-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-lightbulb"></i> 相关课程推荐</h6>
                    </div>
                    <div class="card-body">
                        {% for rc in related_courses %}
                        <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <h6 class="mb-1">{{ rc.title }}</h6>
                            <p class="text-muted small mb-2">{{ rc.description[:50] }}...</p>
                            <a href="/course/{{ rc.id }}" class="btn btn-sm btn-outline-primary">查看详情</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- 购买课程模态框 -->
<div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="purchaseModalLabel">
                    <i class="fas fa-shopping-cart"></i> 购买课程
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h4 class="fw-bold">{{ course.title }}</h4>
                    <h3 class="text-primary">{{ course.price }}</h3>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center">
                            <h6 class="fw-bold mb-3"><i class="fas fa-qrcode"></i> 微信支付</h6>
                            <img src="/static/images/check.jpg" class="img-fluid rounded shadow mb-2" alt="微信收款码" style="max-width: 280px;">
                            <p class="text-muted small">请扫码支付 {{ course.price }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <h6 class="fw-bold mb-3"><i class="fab fa-weixin"></i> 添加微信咨询</h6>
                            <img src="/static/images/wx.jpg" class="img-fluid rounded shadow mb-2" alt="微信二维码" style="max-width: 280px;">
                            <p class="text-muted small">扫码添加微信，获取课程详情</p>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>温馨提示：</strong>支付后请添加微信并发送支付截图，我们将在1小时内开通课程权限。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
// 收藏课程功能
function toggleFavorite(btn) {
    const favText = document.getElementById('favText');
    const icon = btn.querySelector('i');

    if (btn.classList.contains('btn-outline-primary')) {
        // 收藏
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary');
        icon.classList.add('fas');
        icon.classList.remove('far');
        favText.textContent = '已收藏';

        // 显示成功提示
        showToast('success', '收藏成功！');
    } else {
        // 取消收藏
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        icon.classList.remove('fas');
        icon.classList.add('far');
        favText.textContent = '收藏课程';

        showToast('info', '已取消收藏');
    }
}

// 显示提示消息
function showToast(type, message) {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 250px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    toast.innerHTML = `
        <strong><i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.getElementById('toastContainer').appendChild(toast);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

{% endif %}
{% endblock %}
